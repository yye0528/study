/*
 * main.cpp
 *
 *  Created on: Sep 2, 2013
 *      Author: ryan
 */


#include <stdio.h>
#include <cstdlib>
#include <iostream>
#include <iomanip>
#include <string.h>
#include <fstream>
#include <sstream>

#include <dirent.h>

#include <sys/types.h>
#include <sys/stat.h>

#include <pwd.h>
#include <grp.h>
#include <time.h>
#include <locale.h>
#include <langinfo.h>
#include <stdint.h>

using namespace std;

class Console{
	private:
		string cmd;
		string currDir;
	public:
		Console():cmd(""),currDir("/home/ryan")
			{}

		void usrinput(){
			//get command from user input
			do{
		    	cout<<"$";
		    	getline(cin,cmd);
		    	if (cmd=="list-short"){
		    		ls(currDir); //call list-short
		    	}else if(cmd=="list-long"){
		    		ls(currDir,true); // call list-long
		    	}else if(cmd.find("change")!=string::npos){
		    		string targetDir=cmd.erase(0,7); //get dir by removing "change" from command
		    		currDir=targetDir;
		    	}
		    }while(cmd != "exit");

		}

		//list-short
		void ls(string currDir){
			DIR 			*dir;
			struct dirent 	*entry;

		    if(dir=opendir(currDir.c_str())){
				while((entry = readdir(dir))!=NULL){
					cout<<entry->d_name<<"\n";
				}
				closedir(dir);
			}else{
				cout<<"error in openning the file \n";
			}
		}

		//list-long
		void ls(string currDir, bool isLong){
			DIR 			*dir;
			struct dirent 	*entry;
			struct stat 	statBuf;
			struct passwd  	*pwd;
			struct group   	*grp;
			int 			mode;
			char 			modeStr[10];
			char			usrname[32];

		    if(dir=opendir(currDir.c_str())){
				while((entry = readdir(dir))!=NULL){

					//file information
					if(stat(entry->d_name, &statBuf) !=-1){

						//permissions
						mode=statBuf.st_mode;
						strcpy( modeStr, "----------" );
						if ( S_ISDIR(mode) )  modeStr[0] = 'd';    //directory
					    if ( S_ISCHR(mode) )  modeStr[0] = 'c';    //char devices
					    if ( S_ISBLK(mode) )  modeStr[0] = 'b';    //block device
					    if ( mode & S_IRUSR ) modeStr[1] = 'r';    //owner
					    if ( mode & S_IWUSR ) modeStr[2] = 'w';
					    if ( mode & S_IXUSR ) modeStr[3] = 'x';
					    if ( mode & S_IRGRP ) modeStr[4] = 'r';    //group
					    if ( mode & S_IWGRP ) modeStr[5] = 'w';
					    if ( mode & S_IXGRP ) modeStr[6] = 'x';
					    if ( mode & S_IROTH ) modeStr[7] = 'r';    //other
					    if ( mode & S_IWOTH ) modeStr[8] = 'w';
					    if ( mode & S_IXOTH ) modeStr[9] = 'x';

					    //user name
					    if ((pwd = getpwuid(statBuf.st_uid)) != NULL){
					    	usrname=pwd->pw_name;
					    }

					    if ((grp = getgrgid(statbuf.st_gid)) != NULL){

					    }
					}
					//print
					cout<<modeStr<<" "<<entry->d_name<<"\n";
				}
				closedir(dir);
			}else{
				cout<<"error in openning the file \n";
			}
		}
};

int main(){
	Console console;
	console.usrinput();
    return 0;
}


